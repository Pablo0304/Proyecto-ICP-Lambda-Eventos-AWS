{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "S3 buckets for input, artifacts, and output",
  "Parameters": {
    "PipelineName": { "Type": "String" },
    "StartStateMachineLambdaArn": { "Type": "String" }
  },
  "Resources": {
    "StartStateMachineInvokePermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": { "Ref": "StartStateMachineLambdaArn" },
        "Principal": "s3.amazonaws.com",
        "SourceArn": { "Fn::Sub": "arn:aws:s3:::${PipelineName}-input" }
      }
    },
    "InputBucket": {
      "Type": "AWS::S3::Bucket",
      "DependsOn": ["StartStateMachineInvokePermission"],
      "Properties": {
        "BucketName": { "Fn::Sub": "${PipelineName}-input" },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            { "ServerSideEncryptionByDefault": { "SSEAlgorithm": "AES256" } }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "NotificationConfiguration": {
          "LambdaConfigurations": [
            {
              "Event": "s3:ObjectCreated:*",
              "Function": { "Ref": "StartStateMachineLambdaArn" }
            }
          ]
        }
      }
    },
    "ArtifactsBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "${PipelineName}-artifacts" },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            { "ServerSideEncryptionByDefault": { "SSEAlgorithm": "AES256" } }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        }
      }
    },
    "OutputBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "${PipelineName}-output" },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            { "ServerSideEncryptionByDefault": { "SSEAlgorithm": "AES256" } }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "ColdStorageLifecycle",
              "Status": "Enabled",
              "Transitions": [
                { "StorageClass": "STANDARD_IA", "TransitionInDays": 30 },
                { "StorageClass": "GLACIER", "TransitionInDays": 90 },
                { "StorageClass": "DEEP_ARCHIVE", "TransitionInDays": 180 }
              ]
            }
          ]
        }
      }
    }
  },
  "Outputs": {
    "InputBucketName": { "Value": { "Ref": "InputBucket" } },
    "ArtifactsBucketName": { "Value": { "Ref": "ArtifactsBucket" } },
    "OutputBucketName": { "Value": { "Ref": "OutputBucket" } },
    "InputBucketArn": { "Value": { "Fn::GetAtt": ["InputBucket", "Arn"] } },
    "ArtifactsBucketArn": { "Value": { "Fn::GetAtt": ["ArtifactsBucket", "Arn"] } },
    "OutputBucketArn": { "Value": { "Fn::GetAtt": ["OutputBucket", "Arn"] } }
  }
}
